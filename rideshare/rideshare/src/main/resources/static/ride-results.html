<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Results</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="dashboard-container">
  <h2>Ride Search Results</h2>
  <p id="searchSummary">Loading search results...</p>

  <div id="resultsContainer">
    <p>A table of results will be displayed here.</p>
  </div>

  <button style="margin-top: 20px;" onclick="window.location.href='search-ride.html'">New Search</button>
</div>

<script src="js/common.js"></script>
<script src="js/common.js"></script>
<script>
  const BASE_URL = "http://localhost:8080/api/auth";
  const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));

  document.addEventListener('DOMContentLoaded', loadSearchResults);

  async function loadSearchResults() {
      const resultsDiv = document.getElementById('resultsContainer');
      const summaryP = document.getElementById('searchSummary');
      const storedParams = sessionStorage.getItem('lastSearchParams');

      if (!storedParams) {
          summaryP.textContent = "No recent search performed.";
          resultsDiv.innerHTML = '<p>Please go back and perform a search.</p>';
          return;
      }

      const params = JSON.parse(storedParams);

      summaryP.innerHTML = `Searching for rides from <strong>${params.source}</strong> to <strong>${params.destination}</strong>.`;
      resultsDiv.innerHTML = '<p>Loading rides...</p>';

      // 1. Construct API URL with parameters
      const url = `http://localhost:8080/api/rides/search?source=${encodeURIComponent(params.source)}&destination=${encodeURIComponent(params.destination)}&date=${encodeURIComponent(params.date)}&price=${params.price}&type=${params.vehicleType}&rating=${params.rating}`;

      try {
          const response = await fetch(url);

          if (!response.ok) {
              throw new Error(response.statusText || 'Failed to retrieve data.');
          }

          // CRITICAL CHANGE: Expect JSON array of rides
          const rides = await response.json();

          // Build the table header
          let tableHtml = `
              <h3>Found ${rides.length} Ride(s)</h3>
              <table style="width: 100%; border-collapse: collapse;">
                  <thead><tr><th>Source</th><th>Destination</th><th>Date/Time</th><th>Seats Left</th><th>Driver ID</th><th>Action</th></tr></thead>
                  <tbody>`;

          if (rides.length === 0) {
               tableHtml += '<tr><td colspan="6" style="text-align:center;">No rides match your search criteria.</td></tr>';
          } else {
              // 2. Loop through actual results and build rows
              rides.forEach(ride => {
                  tableHtml += `
                      <tr>
                          <td>${ride.source}</td>
                          <td>${ride.destination}</td>
                          <td>${ride.dateTime.replace('T', ' ')}</td>
                          <td>${ride.availableSeats}</td>
                          <td>${ride.driverId}</td>
                          <td><button class="small-button" onclick="bookRide(${ride.id}, 1)">Book Seat</button></td>
                      </tr>
                  `;
              });
          }

          tableHtml += `</tbody></table>`;
          resultsDiv.innerHTML = tableHtml;

          Swal.fire('Search Complete', `Found ${rides.length} rides.`, 'success');

      } catch (error) {
          Swal.fire('Connection Error', `Failed to load search results: ${error.message}`, 'error');
          resultsDiv.innerHTML = '<h3>Error</h3><p>Failed to connect to backend or retrieve data.</p>';
      }
  }

  // --- Booking Logic (Remains the same) ---
  async function bookRide(rideId, seats) {
      if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
          Swal.fire('Access Denied', 'Please log in as a Passenger to book seats.', 'warning');
          return;
      }

      try {
          const bookingRequest = {
              rideId: rideId,
              passengerId: LOGGED_IN_USER.id,
              seatsBooked: seats,
          };

          const response = await fetch('http://localhost:8080/api/booking/book', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(bookingRequest)
          });

          const resultText = await response.text();

        if (response.ok) {
    Swal.fire('Booking Success!', resultText, 'success').then(() => {
        // Refresh search results to show updated seat counts
        loadSearchResults();
    });
} else {
    Swal.fire('Booking Failed', resultText || 'Server error during booking.', 'error');
}

      } catch (error) {
          Swal.fire('Connection Error', 'Could not connect to the booking service.', 'error');
      }
  }
</script>
</body>
</html>