<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ride Requests - RideShare</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Basic table style for ride requests */
    #requestsTableContainer table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    #requestsTableContainer th, #requestsTableContainer td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
    }
    #requestsTableContainer th {
        background-color: #4facfe;
        color: white;
    }
    .status-BOOKED { color: green; font-weight: bold; }
    .status-REQUESTED { color: orange; font-weight: bold; }
    .status-PENDING { color: orange; font-weight: bold; }
    .status-ACCEPTED { color: #007bff; font-weight: bold; }
    .status-APPROVED { color: green; font-weight: bold; }
    .status-DENIED { color: red; font-weight: bold; }
    .status-REJECTED { color: red; font-weight: bold; }

    .action-cell {
        display: flex;
        flex-direction: column; /* Stack buttons vertically */
        align-items: center;    /* Center the stack in the column */
        gap: 5px;               /* Small gap between the buttons */
    }

    /* Refine small button size */
    .small-button {
        padding: 5px 10px;      /* Smaller padding */
        font-size: 0.9em;       /* Slightly smaller font */
        width: 100%;            /* Force button to take full width of the stack (needs max-width) */
        max-width: 80px;        /* Constraint the maximum width */
        margin: 0 !important;   /* Remove extraneous margins from other styles */
    }

    .action-btn-accept { background-color: #4CAF50; color: white; margin-right: 5px;}
    .action-btn-deny { background-color: #f44336; color: white; }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        padding: 15px;
    }
    .pagination button {
        background-color: #4facfe;
        color: white;
        padding: 8px 15px;
        min-width: 40px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .pagination button:hover:not(:disabled) {
        background-color: #00f2fe;
        color: #333;
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination .page-info {
        font-weight: bold;
        color: #4facfe;
    }

  </style>
<!--  <style>-->
<!--    /* ... existing table styles ... */-->
<!--    /* NEW: Ensure the body uses the correct background image */-->
<!--    body {-->
<!--      background: url('images/blue_abstract_bg.png') no-repeat center center fixed;-->
<!--      background-size: cover;-->
<!--      margin: 0;-->
<!--      padding: 0;-->
<!--      font-family: 'Poppins', sans-serif;-->
<!--    }-->
<!--  </style>-->
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="home-container">
  <h2>Pending Ride Requests & Bookings</h2>
  <p id="driverNameDisplay"></p>

  <div id="requestsTableContainer">
    <p>Loading requests...</p>
  </div>
</div>

<script src="js/common.js"></script>
<script>
  // UPDATED: Base URL now points to the Booking Controller
  const BASE_URL = "http://localhost:8080/api/booking";
  const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));

  // Pagination state
  let allRequests = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  document.addEventListener('DOMContentLoaded', () => {
    if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'DRIVER') {
        Swal.fire('Access Denied', 'Please log in as a Driver.', 'warning').then(() => {
            window.location.href = 'user-login.html';
        });
        return;
    }
    document.getElementById('driverNameDisplay').textContent = `Showing requests for: ${LOGGED_IN_USER.name}`;
    loadRideRequests(LOGGED_IN_USER.id);
  });

  // --- Core Functions for Accept/Deny ---

  async function processRequest(bookingId, newStatus) {
      const action = newStatus === 'APPROVED' ? 'Accept' : 'Deny';

      const confirmation = await Swal.fire({
          title: `${action} Request?`,
          text: `Are you sure you want to ${action.toLowerCase()} this ride request?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: `Yes, ${action} it!`,
          confirmButtonColor: newStatus === 'APPROVED' ? '#4CAF50' : '#f44336'
      });

      if (!confirmation.isConfirmed) {
          return;
      }

      // --- REAL API CALL to update status ---
      try {
          // Calls POST /api/booking/{bookingId}/status?status={newStatus}
          const url = `${BASE_URL}/${bookingId}/status?status=${newStatus}`;
          const response = await fetch(url, { method: 'POST' });

          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(errorText || `Failed to update status to ${newStatus}.`);
          }

          Swal.fire('Success!', `Request ID ${bookingId} has been ${newStatus.toLowerCase()}!`, 'success');
          loadRideRequests(LOGGED_IN_USER.id); // Reload table to reflect new status
      } catch (error) {
           Swal.fire('Error', `Failed to ${action.toLowerCase()} request: ${error.message}`, 'error');
      }
  }

  function acceptRequest(bookingId) {
      processRequest(bookingId, 'APPROVED');
  }

  function denyRequest(bookingId) {
      processRequest(bookingId, 'REJECTED');
  }

  async function loadRideRequests(driverId) {
    const container = document.getElementById('requestsTableContainer');
    container.innerHTML = '<p>Loading requests...</p>';

    // --- REAL API CALL to fetch requests for the driver ---
    // Calls GET /api/booking/driver/{driverId}/requests
    const url = `${BASE_URL}/driver/${driverId}/requests`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch ride requests from the server.');

        allRequests = await response.json();
        currentPage = 1;

        if (allRequests.length === 0) {
            container.innerHTML = '<p>No pending ride requests or bookings found.</p>';
            return;
        }

        displayRequests();
    } catch (error) {
        Swal.fire('Error', `Failed to load ride requests: ${error.message}`, 'error');
        container.innerHTML = '<p>Error loading ride request data.</p>';
    }
  }

  function displayRequests() {
      const container = document.getElementById('requestsTableContainer');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const requestsToDisplay = allRequests.slice(startIndex, endIndex);
      const totalPages = Math.ceil(allRequests.length / itemsPerPage);

      let tableHtml = `
          <div style="text-align: center; margin-bottom: 15px; color: #666;">
              Showing ${startIndex + 1} - ${Math.min(endIndex, allRequests.length)} of ${allRequests.length} requests
          </div>
          <table>
              <thead>
                  <tr>
                      <th>Status</th>
                      <th>Passenger Name</th>
                      <th>Contact</th>
                      <th>Seats</th>
                      <th>Route</th>
                      <th>Action</th>
                  </tr>
              </thead>
              <tbody>`;

      requestsToDisplay.forEach(r => {
          const statusClass = `status-${r.status}`;

          let actionButtons = '';
          if (r.status === 'REQUESTED' || r.status === 'PENDING') {
              actionButtons = `
                  <button class="small-button action-btn-accept" onclick="acceptRequest(${r.bookingId})">Accept</button>
                  <button class="small-button action-btn-deny" onclick="denyRequest(${r.bookingId})">Deny</button>
              `;
          } else if (r.status === 'BOOKED' || r.status === 'ACCEPTED' || r.status === 'APPROVED') {
              actionButtons = 'Confirmed';
          } else {
              actionButtons = r.status;
          }

          tableHtml += `
              <tr>
                  <td><span class="${statusClass}">${r.status}</span></td>
                  <td>${r.passengerName}</td>
                  <td>${r.passengerContact}</td>
                  <td>${r.seats}</td>
                  <td>${r.source} &rarr; ${r.destination}</td>
                  <td>
                      ${actionButtons}
                  </td>
              </tr>`;
      });

      tableHtml += `</tbody></table>`;

      // Add pagination controls if there are multiple pages
      if (totalPages > 1) {
          tableHtml += `
              <div class="pagination">
                  <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
                  <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                  <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                  <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                  <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
              </div>
          `;
      }

      container.innerHTML = tableHtml;
  }

  function changePage(page) {
      const totalPages = Math.ceil(allRequests.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
          currentPage = page;
          displayRequests();
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
  }
</script>
</body>
</html>