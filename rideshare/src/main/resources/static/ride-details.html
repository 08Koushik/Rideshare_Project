<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Ride Details - RideShare</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        /* (kept your existing styles — trimmed inlined for space) */
        body { background: url('images/blue_abstract_bg.png') no-repeat center center fixed; background-size: cover; margin:0; font-family:'Poppins',sans-serif; }
        .ride-details-container{ width:90%; max-width:800px; margin:80px auto; padding:35px; border-radius:12px; background-color: rgba(255,255,255,0.32); backdrop-filter: blur(5px); box-shadow:0 5px 30px rgba(0,0,0,0.15);}
        .info-grid{ display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .info-item strong{ color:#4facfe; display:block; margin-bottom:6px; font-size:0.9em;}
        #imageGallery img{width:100%; height:250px; object-fit:contain; border-radius:8px;}
        #bookSeatBtn{ padding:12px 30px; background:#4caf50; border-radius:10px; color:#fff; border:none; cursor:pointer;}
        #bookSeatBtn[disabled]{ opacity:0.6; cursor:not-allowed;}
    </style>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="ride-details-container">
    <h2 id="pageTitle">Ride Details</h2>
    <div id="loadingMessage" style="text-align:center"><p>Loading ride details...</p></div>

    <div id="content" style="display:none;">
        <h3>Route & Time</h3>
        <div id="rideDetails" class="info-grid"></div>

        <h3>Vehicle Gallery</h3>
        <div id="imageGallery"><p style="grid-column:1/-1;color:gray">Loading images...</p></div>

        <h3>Driver Information</h3>
        <div id="driverDetails" class="info-grid"></div>

        <h3>Vehicle Information</h3>
        <div id="vehicleDetails" class="info-grid"></div>

        <div id="bookingAction" style="text-align:center; margin-top:30px;">
            <label for="seatsInput">Seats to Book:</label>
            <input type="number" id="seatsInput" value="1" min="1" max="4" required>
            <button id="bookSeatBtn">Book 1 Seat (₹0.00)</button>
        </div>
    </div>
</div>

<script src="js/common.js"></script>

<script>
    /* ---------------- CONFIG ---------------- */
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SRY0vF0WiGlpjQcC4MSxsoinZ0zAtwWLGuK9SD2MQUuOVB839mArCluTDOggIJuak6a8H7gVv12TMLJHL0KNGDv00lySQUJqy';
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    /* ---------------- STATE ---------------- */
    const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));
    let stripeElements = null;
    let currentRide = null;

    /* ---------------- LOAD RIDE DATA ---------------- */
    document.addEventListener('DOMContentLoaded', () => {
      const detailsJson = sessionStorage.getItem('selectedRideDetails');
      if (!detailsJson) {
        document.getElementById('loadingMessage').innerHTML = '<p style="color:red;font-weight:bold;">No ride data found. Return to search results.</p>';
        return;
      }

      currentRide = JSON.parse(detailsJson);
      document.getElementById('content').style.display = 'block';
      document.getElementById('loadingMessage').style.display = 'none';

      document.getElementById('pageTitle').textContent = `Ride from ${currentRide.source} to ${currentRide.destination}`;
      document.getElementById('seatsInput').max = currentRide.availableSeats;
      updateBookButtonLabel(1);

      populateRideDetails(currentRide);
      populateDriverDetails(currentRide);
      populateVehicleDetails(currentRide);
      populateImageGallery(currentRide.vehicleImageReferences || []);

      document.getElementById('seatsInput').addEventListener('input', () => {
        const seats = parseInt(document.getElementById('seatsInput').value) || 1;
        updateBookButtonLabel(seats);
      });
      document.getElementById('bookSeatBtn').addEventListener('click', () => {
        const seats = parseInt(document.getElementById('seatsInput').value) || 1;
        bookRide(currentRide.rideId, seats, currentRide.farePerSeat);
      });
    });

    /* ---------------- UI helpers ---------------- */
    function updateBookButtonLabel(seats) {
      const max = parseInt(document.getElementById('seatsInput').max) || 1;
      const btn = document.getElementById('bookSeatBtn');
      if (seats < 1 || seats > max) {
        btn.textContent = 'Invalid Seat Count';
        btn.disabled = true;
        return;
      }
      const total = (seats * (currentRide?.farePerSeat || 0)).toFixed(2);
      btn.textContent = `Book ${seats} Seat(s) (₹${total})`;
      btn.disabled = false;
    }

    function populateRideDetails(r) {
      document.getElementById('rideDetails').innerHTML = `
        <div class="info-item"><strong>Source</strong><span>${r.source}</span></div>
        <div class="info-item"><strong>Destination</strong><span>${r.destination}</span></div>
        <div class="info-item"><strong>Date/Time</strong><span>${new Date(r.dateTime).toLocaleString()}</span></div>
        <div class="info-item"><strong>Fare Per Seat</strong><span>₹${r.farePerSeat.toFixed(2)}</span></div>
        <div class="info-item"><strong>Seats Available</strong><span>${r.availableSeats}</span></div>
      `;
    }
    function populateDriverDetails(r) {
      document.getElementById('driverDetails').innerHTML = `
        <div class="info-item"><strong>Driver Name</strong><span>${r.driverName}</span></div>
        <div class="info-item"><strong>Contact</strong><span>${r.driverContact}</span></div>
        <div class="info-item"><strong>License</strong><span>${r.driverLicenseNumber || 'N/A'}</span></div>
      `;
    }
    function populateVehicleDetails(r) {
      document.getElementById('vehicleDetails').innerHTML = `
        <div class="info-item"><strong>Vehicle Name</strong><span>${r.vehicleName || 'N/A'}</span></div>
        <div class="info-item"><strong>Type</strong><span>${r.vehicleType || 'N/A'}</span></div>
        <div class="info-item"><strong>Number</strong><span>${r.vehicleNumber || 'N/A'}</span></div>
      `;
    }
    function populateImageGallery(arr) {
      const g = document.getElementById('imageGallery');
      g.innerHTML = '';
      if (!arr || arr.length === 0) { g.innerHTML = '<p style="grid-column:1/-1;color:gray">No images available</p>'; return; }
      arr.forEach(url => g.innerHTML += `<img src="${url}" alt="Vehicle Image">`);
    }

    /* ---------------- BOOKING FLOW ----------------
     Steps:
     1) create-intent (POST) -> receive clientSecret
     2) show SweetAlert modal with Stripe Payment Element (mount)
     3) stripe.confirmPayment inside preConfirm -> get paymentIntent.id
     4) POST /api/booking/confirm?paymentIntentId=... with Booking JSON body
     ------------------------------------------------*/
    async function bookRide(rideId, seats, farePerSeat) {
      if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
        Swal.fire('Access Denied','Please log in as a Passenger.','warning');
        return;
      }
      if (seats < 1) { Swal.fire('Invalid','Please choose at least 1 seat','warning'); return; }

      const totalAmt = (farePerSeat * seats).toFixed(2);

      try {
        // 1) create intent (POST)
        const intentResp = await fetch(`/api/booking/create-intent?rideId=${rideId}&seats=${seats}`, { method: 'POST' });
        if (!intentResp.ok) throw new Error(await intentResp.text());
        const { clientSecret } = await intentResp.json();

        // 2) show modal with Payment Element
        const swalResult = await Swal.fire({
          title: `Pay ₹${totalAmt}`,
          html: `<div id="payment-element" style="min-height: 200px;"></div>`,
          showCancelButton: true,
          confirmButtonText: 'Submit Payment',
          didOpen: () => {
            // Create elements with the clientSecret
            stripeElements = stripe.elements({ clientSecret });
            const paymentElement = stripeElements.create('payment');
            paymentElement.mount('#payment-element');
          },
          preConfirm: async () => {
            // confirm payment
            const { error, paymentIntent } = await stripe.confirmPayment({
              elements: stripeElements,
              confirmParams: { return_url: window.location.origin + '/ride-results.html' },
              redirect: 'if_required'
            });

            if (error) {
              Swal.showValidationMessage(error.message);
              return false;
            }
            // if redirect required, stripe may have handled it; if returned, we have paymentIntent
            if (!paymentIntent || !paymentIntent.id) {
              Swal.showValidationMessage('Payment not completed.');
              return false;
            }
            return paymentIntent.id;
          }
        });

        if (!swalResult.isConfirmed || !swalResult.value) {
          // user cancelled or no payment id
          return;
        }

        const paymentIntentId = swalResult.value;

        // 3) call backend confirm endpoint
        const bookingBody = {
          rideId,
          passengerId: LOGGED_IN_USER.id,
          seatsBooked: seats
        };

        // NOTE: full absolute URL is not required when within same host; using relative path avoids CORS problems
        const confirmResp = await fetch(`/api/booking/confirm?paymentIntentId=${encodeURIComponent(paymentIntentId)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookingBody)
        });

        const resultText = await confirmResp.text();
        if (confirmResp.ok) {
          Swal.fire('Success', resultText, 'success').then(() => window.location.href = 'ride-results.html');
        } else {
          Swal.fire('Booking Failed', resultText || 'Server error while booking', 'error');
        }

      } catch (err) {
        console.error('Booking flow error', err);
        Swal.fire('Error', err.message || 'Unknown error', 'error');
      }
    }
</script>

<!-- only include booking.js if it contains finalizeBooking helper and does NOT re-initialize Stripe -->
<script src="js/booking.js"></script>
</body>
</html>
