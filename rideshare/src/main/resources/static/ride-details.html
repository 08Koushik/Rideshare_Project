<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Details - RideShare</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Consistent Page Background */
<!--        body {-->
<!--            background: url('images/blue_abstract_bg.png') no-repeat center center fixed;-->
<!--            background-size: cover;-->
<!--            margin: 0;-->
<!--            padding: 0;-->
<!--            font-family: 'Poppins', sans-serif;-->
<!--            color: #333;-->
<!--        }-->

        /* Consistent Transparent Container (similar to .form-container) */
        .ride-details-container {
            width: 90%;
            max-width: 800px; /* Adjusted for better content presentation */
            margin: 80px auto;
            border-radius: 12px;
            padding: 35px;
            /* Semi-transparent/blur style */
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
        }

        h2 {
            text-align: center;
            color: #4facfe;
            margin-bottom: 25px;
            font-size: 2rem;
        }

        h3 {
            color: #222b45;
            margin-top: 20px;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item strong {
            color: #4facfe;
            display: block;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .info-item span {
            font-size: 1.1em;
            color: #333;
        }

        /* Image Gallery Styles */
        #imageGallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        #imageGallery img {
            width: 100%;
            height: 250px;
            object-fit: contain;
            background-color:#f0f0f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        #imageGallery img:hover {
            transform: scale(1.03);
        }

        /* Booking Button */
        #bookingAction {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Ensure buttons inherit consistent styling from style.css but override the width */
        #bookSeatBtn {
            padding: 12px 30px;
            font-size: 1.1rem;
            background-color: #4caf50; /* Use green for booking action */
            border-radius: 10px;
            transition: background-color 0.3s;
        }
        #bookSeatBtn:hover {
            background-color: #43a047;
        }

        #seatsInput {
            width: 50px;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 0 10px;
        }
    </style>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="ride-details-container">
    <h2 id="pageTitle">Ride Details</h2>

    <div id="loadingMessage" style="text-align: center;">
        <p>Loading ride details...</p>
    </div>

    <div id="content" style="display: none;">

        <h3>Route & Time</h3>
        <div id="rideDetails" class="info-grid">
        </div>

        <h3>Vehicle Gallery</h3>
        <div id="imageGallery">
            <p style="grid-column: 1 / -1; color:gray;">Loading images...</p>
        </div>

        <h3>Driver Information</h3>
        <div id="driverDetails" class="info-grid">
        </div>

        <h3>Vehicle Information</h3>
        <div id="vehicleDetails" class="info-grid">
        </div>

        <div id="bookingAction">
            <label for="seatsInput">Seats to Book:</label>
            <input type="number" id="seatsInput" value="1" min="1" max="4" required>
            <button id="bookSeatBtn">Book 1 Seat (₹0.00)</button>
        </div>
    </div>
</div>

<script src="js/common.js"></script>
<script>
    const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));
    let rideData = null; // Global variable to hold fetched ride data

    document.addEventListener('DOMContentLoaded', loadRideDetails);

    // --- Core Data Loading Function ---
    function loadRideDetails() {
        const detailsJson = sessionStorage.getItem('selectedRideDetails');
        const contentDiv = document.getElementById('content');
        const loadingDiv = document.getElementById('loadingMessage');

        if (!detailsJson) {
            loadingDiv.innerHTML = '<p style="color:red; font-weight:bold;">Error: No ride data found. Please return to the search results page.</p>';
            return;
        }

        try {
            rideData = JSON.parse(detailsJson);
            contentDiv.style.display = 'block';
            loadingDiv.style.display = 'none';

            // 1. Update Title and Booking Button
            document.getElementById('pageTitle').textContent = `Ride from ${rideData.source} to ${rideData.destination}`;
            document.getElementById('seatsInput').max = rideData.availableSeats;

            const initialCost = (rideData.farePerSeat * 1).toFixed(2);
            document.getElementById('bookSeatBtn').textContent = `Book 1 Seat (₹${initialCost})`;

            // 2. Populate Sections
            populateRideDetails(rideData);
            populateDriverDetails(rideData);
            populateVehicleDetails(rideData);
            populateImageGallery(rideData.vehicleImageReferences);

            // 3. Setup Event Listeners
            document.getElementById('seatsInput').addEventListener('input', updateBookingButton);
            document.getElementById('bookSeatBtn').addEventListener('click', () => {
                const seats = parseInt(document.getElementById('seatsInput').value);
                // Validation is also handled in the bookRide function, but basic check here:
                if (seats > 0 && seats <= rideData.availableSeats) {
                    bookRide(rideData.rideId, seats, rideData.farePerSeat);
                } else {
                     Swal.fire('Invalid Seats', `Please select between 1 and ${rideData.availableSeats} seats.`, 'warning');
                }
            });

        } catch (error) {
            loadingDiv.innerHTML = `<p style="color:red; font-weight:bold;">Error parsing ride data: ${error.message}</p>`;
        }
    }

    // --- Helper Functions to Populate HTML ---

    function populateRideDetails(ride) {
        const el = document.getElementById('rideDetails');
        el.innerHTML = `
            <div class="info-item"><strong>Source</strong><span>${ride.source}</span></div>
            <div class="info-item"><strong>Destination</strong><span>${ride.destination}</span></div>
            <div class="info-item"><strong>Date/Time</strong><span>${new Date(ride.dateTime).toLocaleString()}</span></div>
            <div class="info-item"><strong>Fare Per Seat</strong><span>₹${ride.farePerSeat.toFixed(2)}</span></div>
            <div class="info-item"><strong>Seats Available</strong><span>${ride.availableSeats}</span></div>
<!--            <div class="info-item"><strong>Route Stops</strong><span>${(ride.pickupLocations || 'N/A') + ' / ' + (ride.dropLocations || 'N/A')}</span></div>-->
        `;
    }

    function populateDriverDetails(ride) {
        const el = document.getElementById('driverDetails');
        el.innerHTML = `
            <div class="info-item"><strong>Driver Name</strong><span>${ride.driverName}</span></div>
            <div class="info-item"><strong>Contact Number</strong><span>${ride.driverContact}</span></div>
            <div class="info-item"><strong>License Number</strong><span>${ride.driverLicenseNumber || 'N/A'}</span></div>
        `;
    }

    function populateVehicleDetails(ride) {
        const el = document.getElementById('vehicleDetails');
        el.innerHTML = `
            <div class="info-item"><strong>Vehicle Name</strong><span>${ride.vehicleName || 'N/A'}</span></div>
            <div class="info-item"><strong>Vehicle Type</strong><span>${ride.vehicleType || 'N/A'}</span></div>
            <div class="info-item"><strong>Vehicle Number</strong><span>${ride.vehicleNumber}</span></div>
        `;
    }

    function populateImageGallery(imageReferences) {
        const galleryEl = document.getElementById('imageGallery');
        galleryEl.innerHTML = ''; // Clear loading message

        if (!imageReferences || imageReferences.length === 0) {
            galleryEl.innerHTML = '<p style="grid-column: 1 / -1; color:gray;">No vehicle images uploaded by the driver.</p>';
            return;
        }

        imageReferences.forEach(url => {
            if (url) {
                galleryEl.innerHTML += `<img src="${url}" alt="Vehicle Image">`;
            }
        });
    }

    function updateBookingButton() {
        const seats = parseInt(document.getElementById('seatsInput').value);
        const maxSeats = parseInt(document.getElementById('seatsInput').max);

        if (isNaN(seats) || seats <= 0 || seats > maxSeats) {
             document.getElementById('bookSeatBtn').textContent = `Invalid Seat Count`;
             document.getElementById('bookSeatBtn').disabled = true;
             return;
        }

        const totalCost = (rideData.farePerSeat * seats).toFixed(2);
        document.getElementById('bookSeatBtn').textContent = `Book ${seats} Seat(s) (₹${totalCost})`;
        document.getElementById('bookSeatBtn').disabled = false;
    }

    // --- Booking Logic (Updated to remove payment) ---
    async function bookRide(rideId, seats, farePerSeat) {
        if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
            Swal.fire('Access Denied', 'Please log in as a Passenger to book seats.', 'warning');
            return;
        }

        const totalCost = (farePerSeat * seats).toFixed(2);

        // Confirm booking request
        const confirmResult = await Swal.fire({
            title: 'Confirm Booking Request',
            html: `
                <p>You are requesting to book <strong>${seats} seat(s)</strong></p>
                <p>Estimated Fare: <strong>₹${totalCost}</strong></p>
                <p style="color: #666; font-size: 0.9em;">The driver will receive your request and approve or reject it. You will be notified via email.</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Send Request',
            cancelButtonText: 'Cancel'
        });

        if (!confirmResult.isConfirmed) {
            return;
        }

        try {
            // Send booking request (no payment)
            const bookingUrl = `http://localhost:8080/api/booking/book`;

            const bookingResponse = await fetch(bookingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rideId: rideId,
                    passengerId: LOGGED_IN_USER.id,
                    seatsBooked: seats,
                })
            });

            const resultText = await bookingResponse.text();

            if (bookingResponse.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Request Sent!',
                    html: `
                        <p>${resultText}</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                            You will receive an email notification when the driver responds.
                        </p>
                    `
                }).then(() => {
                    window.location.href = 'passenger-dashboard.html';
                });
            } else {
                Swal.fire('Request Failed', resultText || 'Server error during booking request.', 'error');
            }
        } catch (error) {
            console.error("Booking request error:", error);
            Swal.fire('Error', `Failed to send booking request: ${error.message}`, 'error');
        }
    }
</script>
</body>
</html>