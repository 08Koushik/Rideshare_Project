<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Ride</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
<!--        body {-->
<!--          background: url('images/blue_abstract_bg.png') no-repeat center center fixed;-->
<!--          background-size: cover;-->
<!--          margin: 0;-->
<!--          padding: 0;-->
<!--          font-family: 'Poppins', sans-serif;-->
<!--        }-->
        /* Style for multi-step form navigation buttons */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        .navigation-buttons button {
            width: 48%;
            padding: 10px;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="form-container">
    <h2>Post a Ride (Step <span id="currentStep">1</span> of 3)</h2>
    
    <form id="postRideForm">

        <div id="step1" class="form-step">
            <label for="source">Source</label>
            <input type="text" id="source" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)" required>

            <label for="destination">Destination</label>
            <input type="text" id="destination" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)" required>

            <label for="date">Date</label>
            <input type="date" id="date" required>

            <label for="time">Time</label>
            <input type="time" id="time" required>

            <label for="seats">Available Seats</label>
            <input type="number" id="seats" min="1" max="4" required>

            <input type="hidden" id="vehicle" name="vehicle">
            <input type="hidden" id="license" name="license">

            <div class="navigation-buttons">
                <button type="button" onclick="nextStep()">Next (Step 2)</button>
            </div>
        </div>

        <div id="step2" class="form-step hidden">
            <h3>Pickup Locations (Optional, Max 4)</h3>
            <label for="pickup1">Pickup 1</label>
            <input type="text" id="pickup1" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="pickup2">Pickup 2</label>
            <input type="text" id="pickup2" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="pickup3">Pickup 3</label>
            <input type="text" id="pickup3" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="pickup4">Pickup 4</label>
            <input type="text" id="pickup4" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">

            <h3>Drop Locations (Optional, Max 4)</h3>
            <label for="drop1">Drop 1</label>
            <input type="text" id="drop1" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="drop2">Drop 2</label>
            <input type="text" id="drop2" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="drop3">Drop 3</label>
            <input type="text" id="drop3" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <label for="drop4">Drop 4</label>
            <input type="text" id="drop4" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">

            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Back (Step 1)</button>
                <button type="button" onclick="nextStep()">Next (Step 3)</button>
            </div>
        </div>

        <div id="step3" class="form-step hidden">
            <label for="vehicleName">Vehicle Name</label>
            <input type="text" id="vehicleName" required>

            <label for="vehicleType">Vehicle Type</label>
            <select id="vehicleType" required>
                <option value="">Select Vehicle Type</option>
                <option value="CAR">Car</option>
                <option value="BIKE">Bike</option>
                <option value="VAN">Van</option>
            </select>

            <label for="vehicleImage">Vehicle Image</label>
            <input type="file" id="vehicleImage" accept="image/*" multiple>

            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">Back (Step 2)</button>
                <button type="button" id="postRideBtn" onclick="submitRide()">Post Ride</button>
            </div>
        </div>

    </form>
</div>

<datalist id="location-suggestions"></datalist>

<script src="js/common.js"></script>
<script>
    // Global state for multi-step form
    let currentStep = 1;
    const totalSteps = 3;
    const formSteps = [
        document.getElementById('step1'),
        document.getElementById('step2'),
        document.getElementById('step3')
    ];
    const stepTitle = document.getElementById('currentStep');
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser")); // Retrieved from user-home.html logic

    function updateStepVisibility() {
        formSteps.forEach((step, index) => {
            step.classList.toggle('hidden', index + 1 !== currentStep);
        });
        stepTitle.textContent = currentStep;
    }

    function validateStep(step) {
        let isValid = true;
        const inputs = formSteps[step - 1].querySelectorAll('[required]');
        inputs.forEach(input => {
            // Note: input type="file" is not required in Step 3
            if (input.type !== 'file' && !input.value) {
                input.reportValidity(); // Show native browser validation error
                isValid = false;
            }
        });
        return isValid;
    }

    function nextStep() {
        if (validateStep(currentStep)) {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepVisibility();
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepVisibility();
        }
    }

    // Direct submit function for the Post Ride button
    function submitRide() {
        console.log('=== POST RIDE BUTTON CLICKED ===');
        handleFormSubmit(new Event('submit'));
    }

    // 1. LocationIQ Autocomplete Logic (from original file)
    const LOCATIONIQ_API_KEY = 'pk.8c6dc49f1003f5c138f99ed064ad5a43';

    let debounceTimer;
    function fetchLocationSuggestions(inputElement) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const query = inputElement.value.trim();
            if (query.length < 3) return;

            const datalist = document.getElementById('location-suggestions');
            const url = `https://api.locationiq.com/v1/autocomplete?key=${LOCATIONIQ_API_KEY}&q=${encodeURIComponent(query)}&limit=5&countrycodes=in`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                datalist.innerHTML = '';

                if (Array.isArray(data)) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.display_name;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("LocationIQ Autocomplete Error:", error);
            }
        }, 300);
    }

    // Initialize step visibility and attach event listeners
    document.addEventListener('DOMContentLoaded', () => {
        console.log('=== POST RIDE PAGE LOADED ===');
        console.log('1. DOM loaded, initializing form...');
        
        try {
            updateStepVisibility();
            console.log('2. Step visibility updated');
        } catch(e) {
            console.error('Error updating step visibility:', e);
        }

        console.log('3. Checking logged in user...');
        console.log('loggedInUser:', loggedInUser);
        
        if (!loggedInUser) {
            console.error('No user found in localStorage!');
            alert('Please login first');
            window.location.href = 'user-login.html';
            return;
        }
        
        console.log('4. User role:', loggedInUser.roleType);
        
        if (loggedInUser.roleType !== 'DRIVER') {
            console.error('User is not a driver');
            alert('Only drivers can post rides');
            window.location.href = 'driver-dashboard.html';
            return;
        }

        console.log('5. User is a valid driver, proceeding...');

        // Auto-fill hidden fields from loggedInUser object
        document.getElementById('vehicle').value = loggedInUser.vehicleDetails || '';
        document.getElementById('license').value = loggedInUser.driverLicenseNumber || '';
        
        // Attach form submission handler
        console.log('6. Attaching form submit handler...');
        const form = document.getElementById('postRideForm');
        if (!form) {
            console.error('Form not found!');
            alert('Form not found!');
            return;
        }
        
        form.addEventListener('submit', handleFormSubmit);
        console.log('7. âœ… Form ready! You can now fill and submit.');
    });

    // 2. Form Submission Logic (on Step 3 submit)
    async function handleFormSubmit(e) {
        if (e && e.preventDefault) {
            e.preventDefault();
        }
        console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
        console.log('Form submitted, currentStep:', currentStep);
        console.log('Logged in user:', loggedInUser);

        // Ensure we're on step 3
        if (currentStep !== 3) {
            console.error('Form submitted but not on step 3. Current step:', currentStep);
            alert('Please complete all steps before submitting');
            return;
        }

        if (!loggedInUser) {
            console.error('No user logged in');
            alert('Please login to post rides');
            window.location.href = 'user-login.html';
            return;
        }

        if (loggedInUser.roleType !== 'DRIVER') {
            console.error('User is not a driver, role:', loggedInUser.roleType);
            alert('Only drivers can post rides');
            return;
        }
        
        if (!validateStep(currentStep)) {
            console.error('Validation failed for step:', currentStep);
            alert('Please fill all required fields');
            return;
        }
        
        console.log('All validations passed, proceeding with data collection...');

        // Collect optional pickup/drop locations into a delimited string
        const getLocations = (prefix) => {
            const locations = [];
            for (let i = 1; i <= 4; i++) {
                const loc = document.getElementById(prefix + i).value.trim();
                if (loc) locations.push(loc);
            }
            return locations.join(';'); // Use semicolon as delimiter
        };

        // --- 1. COLLECT DATA ---
        const rideData = {
            // Step 1 Fields
            source: document.getElementById('source').value,
            destination: document.getElementById('destination').value,
            dateTime: document.getElementById('date').value + 'T' + document.getElementById('time').value + ':00',
            availableSeats: parseInt(document.getElementById('seats').value),
            driverId: loggedInUser.id,

            // Step 2 Fields
            pickupLocations: getLocations('pickup'),
            dropLocations: getLocations('drop'),

            // Step 3 Fields
            vehicleName: document.getElementById('vehicleName').value,
            vehicleType: document.getElementById('vehicleType').value,
            // vehicleImageReference is now handled by the server
        };

        console.log('Ride data collected:', rideData);

        const fileInput = document.getElementById('vehicleImage');
        console.log('File input files:', fileInput.files.length);

        // --- 2. CREATE MULTIPART FORM DATA ---
        const formData = new FormData();

        // Append JSON data as a Blob part named 'rideData'
        formData.append('rideData', new Blob([JSON.stringify(rideData)], {
            type: 'application/json'
        }));

        if (fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                // Key matches the controller's @RequestPart name
                formData.append('vehicleImages', fileInput.files[i]);
                console.log('Added file:', fileInput.files[i].name);
            }
        }

        console.log('FormData prepared, sending request...');

        // --- 3. SEND REQUEST WITH FormData (CRITICAL FIX) ---
        try {
            const result = await fetch(`http://localhost:8080/api/rides/post`, {
                method: 'POST',
                // IMPORTANT: DO NOT set Content-Type header when using FormData
                body: formData
            });

            console.log('Response status:', result.status);
            console.log('Response ok:', result.ok);

            if (result.ok) {
                const responseData = await result.json();
                console.log('Success response:', responseData);
                alert('Ride posted successfully!');
                window.location.href = 'driver-dashboard.html';
            } else {
                const errorText = await result.text();
                console.error('Error response:', errorText);
                alert('Posting Failed: ' + (errorText || 'Server error during posting. Check console.'));
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            alert('Connection Error: Could not connect to the server. Ensure backend is running.');
        }
    }
</script>
</body>
</html>