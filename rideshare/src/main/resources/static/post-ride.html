<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Ride</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background: url('images/blue_abstract_bg.png') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        .hidden {
            display: none !important;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .navigation-buttons button {
            width: 48%;
        }
    </style>
</head>

<body>

<div class="back-nav">
    <a href="javascript:history.back()">&leftarrow; Back</a>
</div>

<div class="form-container">
    <h2>Post a Ride (Step <span id="currentStep">1</span> of 3)</h2>

    <form id="postRideForm" enctype="multipart/form-data">

        <!-- STEP 1 -->
        <div id="step1" class="form-step">
            <label>Source</label>
            <input type="text" id="source" name="source" list="location-suggestions" required onkeyup="fetchLocationSuggestions(this)">

            <label>Destination</label>
            <input type="text" id="destination" name="destination" list="location-suggestions" required onkeyup="fetchLocationSuggestions(this)">

            <label>Date</label>
            <input type="date" id="date" name="date" required>

            <label>Time</label>
            <input type="time" id="time" name="time" required>

            <label>Available Seats</label>
            <input type="number" id="seats" name="seats" min="1" max="4" required>

            <input type="hidden" id="vehicle" name="vehicle">
            <input type="hidden" id="license" name="license">

            <div class="navigation-buttons">
                <button type="button" onclick="nextStep()">Next →</button>
            </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" class="form-step hidden">
            <h3>Pickup Locations (Optional)</h3>

            <input type="text" id="pickup1" name="pickup1" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="pickup2" name="pickup2" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="pickup3" name="pickup3" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="pickup4" name="pickup4" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">

            <h3>Drop Locations (Optional)</h3>

            <input type="text" id="drop1" name="drop1" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="drop2" name="drop2" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="drop3" name="drop3" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">
            <input type="text" id="drop4" name="drop4" list="location-suggestions" onkeyup="fetchLocationSuggestions(this)">

            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">← Back</button>
                <button type="button" onclick="nextStep()">Next →</button>
            </div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" class="form-step hidden">
            <label>Vehicle Name</label>
            <input type="text" id="vehicleName" name="vehicleName" required>

            <label>Vehicle Type</label>
            <select id="vehicleType" name="vehicleType" required>
                <option value="">Select type</option>
                <option value="CAR">Car</option>
                <option value="BIKE">Bike</option>
                <option value="VAN">Van</option>
            </select>

            <label>Vehicle Images</label>
            <input type="file" id="vehicleImage" name="vehicleImages" accept="image/*" multiple>

            <div class="navigation-buttons">
                <button type="button" onclick="prevStep()">← Back</button>
                <button type="submit">Post Ride</button>
            </div>
        </div>

    </form>
</div>

<datalist id="location-suggestions"></datalist>

<script src="js/common.js"></script>

<script>
    /* -----------------------
       STEP LOGIC FIXED
    ------------------------*/
    let currentStep = 1;
    const totalSteps = 3;
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

    function updateStepVisibility() {
        document.querySelectorAll(".form-step").forEach((step, index) => {
            const visible = index + 1 === currentStep;
            step.classList.toggle("hidden", !visible);

            // disable required inputs in hidden steps
            step.querySelectorAll("[required]").forEach(input => {
                input.disabled = !visible;
            });
        });

        document.getElementById("currentStep").innerText = currentStep;
    }

    function nextStep() {
        if (validateStep(currentStep)) {
            currentStep++;
            updateStepVisibility();
        }
    }

    function prevStep() {
        currentStep--;
        updateStepVisibility();
    }

    function validateStep(step) {
        const inputs = document.querySelectorAll(`#step${step} [required]:not([disabled])`);
        for (let input of inputs) {
            if (!input.value) {
                input.reportValidity();
                return false;
            }
        }
        return true;
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateStepVisibility();

        if (!loggedInUser || loggedInUser.roleType !== "DRIVER") {
            Swal.fire("Access Denied", "Only drivers can post rides.", "error")
                .then(() => location.href = "user-login.html");
            return;
        }

        document.getElementById("vehicle").value = loggedInUser.vehicleDetails || "";
        document.getElementById("license").value = loggedInUser.driverLicenseNumber || "";
    });

    /* -----------------------
       LOCATIONIQ AUTOCOMPLETE
    ------------------------*/
    const LOCATIONIQ_API_KEY = "pk.a255f03860b88af0a3d4097bf6e4a442";
    let debounceTimer;

    function fetchLocationSuggestions(input) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            if (input.value.length < 3) return;

            const url =
                `https://api.locationiq.com/v1/autocomplete?key=${LOCATIONIQ_API_KEY}&q=${encodeURIComponent(input.value)}&limit=5&countrycodes=in`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                const list = document.getElementById("location-suggestions");
                list.innerHTML = "";

                if (Array.isArray(data)) {
                    data.forEach(item => {
                        let option = document.createElement("option");
                        option.value = item.display_name;
                        list.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("Location Autocomplete Error:", err);
            }
        }, 300);
    }

    /* -----------------------
       SUBMIT FORM
    ------------------------*/
    document.getElementById("postRideForm").addEventListener("submit", async e => {
        e.preventDefault();

        // re-enable disabled inputs so they are included in FormData
        document.querySelectorAll("[disabled]").forEach(i => i.disabled = false);

        const collect = prefix =>
            [1,2,3,4]
                .map(i => document.getElementById(prefix + i).value.trim())
                .filter(x => x)
                .join(";");

        const rideData = {
            source: source.value,
            destination: destination.value,
            dateTime: `${date.value}T${time.value}:00`,
            availableSeats: parseInt(seats.value),
            driverId: loggedInUser.id,
            pickupLocations: collect("pickup"),
            dropLocations: collect("drop"),
            vehicleName: vehicleName.value,
            vehicleType: vehicleType.value
        };

        const formData = new FormData();
        formData.append("rideData", new Blob([JSON.stringify(rideData)], { type: "application/json" }));

        const files = vehicleImage.files;
        for (let file of files) {
            formData.append("vehicleImages", file);
        }

        try {
            const res = await fetch("http://localhost:8080/api/rides/post", {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                Swal.fire("Success!", "Ride posted successfully!", "success")
                    .then(() => location.href = "driver-dashboard.html");
            } else {
                Swal.fire("Posting Failed", await res.text(), "error");
            }
        } catch (error) {
            Swal.fire("Server Error", "Could not connect to backend.", "error");
            console.error(error);
        }
    });
</script>

</body>
</html>
