<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Ride History - RideShare</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Borrowing table style from transaction-history.html */
        #historyTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        /* ENHANCED FIX: Restore header color */
        #historyTableContainer th {
            background-color: #4facfe;
            color: white;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        /* ENHANCED FIX: Ensure data rows are white with borders */
        #historyTableContainer td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            background-color: white; /* Ensure white background */
        }
    </style>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="home-container" style="max-width: 90%; margin: 80px auto;">
    <h2>Your Posted Rides History</h2>
    <p id="userNameDisplay"></p>

    <div id="historyTableContainer">
        <p>Loading rides...</p>
    </div>

    <div id="paginationControls" style="text-align: center; margin-top: 20px;">
        <button id="prevPageBtn" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPageBtn" disabled>Next</button>
    </div>
</div>

<script src="js/common.js"></script>
<script>
    const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));
    let currentPage = 0; // Spring Data pages start at 0
    const pageSize = 10;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', () => {
      if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'DRIVER') {
          Swal.fire('Access Denied', 'Please log in as a Driver.', 'warning').then(() => {
              window.location.href = 'user-login.html';
          });
          return;
      }
      document.getElementById('userNameDisplay').textContent = `Showing posted rides for: ${LOGGED_IN_USER.name}`;
      loadDriverRideHistory(LOGGED_IN_USER.id, currentPage);

      document.getElementById('prevPageBtn').addEventListener('click', () => {
          if (currentPage > 0) {
              currentPage--;
              loadDriverRideHistory(LOGGED_IN_USER.id, currentPage);
          }
      });

      document.getElementById('nextPageBtn').addEventListener('click', () => {
          if (currentPage < totalPages - 1) {
              currentPage++;
              loadDriverRideHistory(LOGGED_IN_USER.id, currentPage);
          }
      });
    });

    function updatePaginationControls(page) {
        totalPages = page.totalPages;
        currentPage = page.number;

        document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages} (Total: ${page.totalElements})`;
        document.getElementById('prevPageBtn').disabled = !page.hasPrevious;
        document.getElementById('nextPageBtn').disabled = !page.hasNext;
    }

    async function loadDriverRideHistory(driverId, pageNum) {
      const container = document.getElementById('historyTableContainer');
      container.innerHTML = '<p>Loading rides...</p>';

      // MODIFIED URL: Added pagination parameters
      const url = `http://localhost:8080/api/rides/driver/${driverId}/history?page=${pageNum}&size=${pageSize}`;

      try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch data.');

          const page = await response.json();
          const rides = page.content;
          updatePaginationControls(page);

          if (rides.length === 0 && pageNum === 0) {
              container.innerHTML = '<p>No rides posted yet.</p>';
              return;
          }
          if (rides.length === 0) {
               container.innerHTML = '<p>No more results on this page.</p>';
               return;
          }

          let tableHtml = `
              <table>
                  <thead>
                      <tr>
                          <th>Date/Time</th>
                          <th>Route</th>
                          <th>Seats Offered</th>
                          <th>Fare/Seat (₹)</th>
                      </tr>
                  </thead>
                  <tbody>`;

          rides.forEach(r => {
              tableHtml += `
                  <tr>
                      <td>${new Date(r.dateTime).toLocaleString()}</td>
                      <td>${r.source} to ${r.destination}</td>
                      <td>${r.availableSeats}</td>
                      <td>₹${r.farePerSeat ? r.farePerSeat.toFixed(2) : 'N/A'}</td>
                  </tr>`;
          });

          tableHtml += `</tbody></table>`;
          container.innerHTML = tableHtml;

      } catch (error) {
          Swal.fire('Error', `Failed to load ride history: ${error.message}`, 'error');
          container.innerHTML = '<p>Error loading ride data.</p>';
      }
    }
</script>
</body>
</html>