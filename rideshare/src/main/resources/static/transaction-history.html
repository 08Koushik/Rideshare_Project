<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History - RideShare</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="home-container" style="max-width: 90%; margin: 80px auto;">
    <h2>Transaction History</h2>
    <p id="userNameDisplay"></p>

    <div id="historyTableContainer">
        <p>Loading transactions...</p>
    </div>

    <div id="paginationControls" style="text-align: center; margin-top: 20px;">
        <button id="prevPageBtn" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPageBtn" disabled>Next</button>
    </div>
</div>

<script src="js/common.js"></script>
<script>
    const BASE_URL = "http://localhost:8080/api/auth"; // NOTE: The PaymentController uses /api/payments not /api/auth
    const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));
    let currentPage = 0; // Spring Data pages start at 0
    const pageSize = 10;
    let totalPages = 1;


    document.addEventListener('DOMContentLoaded', () => {
      if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
          Swal.fire('Access Denied', 'Please log in as a Passenger.', 'warning').then(() => {
              window.location.href = 'user-login.html';
          });
          return;
      }
      document.getElementById('userNameDisplay').textContent = `Showing history for: ${LOGGED_IN_USER.name}`;
      loadTransactionHistory(LOGGED_IN_USER.id, currentPage);

      document.getElementById('prevPageBtn').addEventListener('click', () => {
          if (currentPage > 0) {
              currentPage--;
              loadTransactionHistory(LOGGED_IN_USER.id, currentPage);
          }
      });

      document.getElementById('nextPageBtn').addEventListener('click', () => {
          if (currentPage < totalPages - 1) {
              currentPage++;
              loadTransactionHistory(LOGGED_IN_USER.id, currentPage);
          }
      });
    });

    function updatePaginationControls(page) {
        totalPages = page.totalPages;
        currentPage = page.number;

        document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages} (Total: ${page.totalElements})`;
        document.getElementById('prevPageBtn').disabled = !page.hasPrevious;
        document.getElementById('nextPageBtn').disabled = !page.hasNext;
    }

    async function loadTransactionHistory(passengerId, pageNum) {
      const container = document.getElementById('historyTableContainer');
      container.innerHTML = '<p>Loading transactions...</p>';

      // CRITICAL: The endpoint is /api/payments, outside the /api/auth path defined in common.js BASE_URL
      // MODIFIED URL: Added pagination parameters
      const url = `http://localhost:8080/api/payments/passenger/${passengerId}?page=${pageNum}&size=${pageSize}`;

      try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch data.');

          const page = await response.json();
          const payments = page.content;
          updatePaginationControls(page);

          if (payments.length === 0 && pageNum === 0) {
              container.innerHTML = '<p>No transactions found.</p>';
              return;
          }
          if (payments.length === 0) {
               container.innerHTML = '<p>No more results on this page.</p>';
               return;
          }

          let tableHtml = `
              <table>
                  <thead>
                      <tr>
                          <th>Date</th>
                          <th>Amount (₹)</th>
                          <th>Status</th>
                          <th>Transaction ID</th>
                      </tr>
                  </thead>
                  <tbody>`;

          payments.forEach(p => {
              tableHtml += `
                  <tr>
                      <td>${new Date(p.paymentDate).toLocaleString()}</td>
                      <td>₹${p.amount.toFixed(2)}</td>
                      <td><span style="color: ${p.status === 'SUCCESS' ? 'green' : 'red'}; font-weight: bold;">${p.status}</span></td>
                      <td>${p.transactionId}</td>
                  </tr>`;
          });

          tableHtml += `</tbody></table>`;
          container.innerHTML = tableHtml;

      } catch (error) {
          Swal.fire('Error', `Failed to load history: ${error.message}`, 'error');
          container.innerHTML = '<p>Error loading transaction data.</p>';
      }
    }
</script>
<style>
    /* Basic table style for transaction history, borrowing from ride-results or style.css */

    #historyTableContainer table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    /* ENHANCED FIX: Restore header color */
    #historyTableContainer th {
      background-color: #4facfe;
      color: white;
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    /* ENHANCED FIX: Ensure data rows are white with borders */
    #historyTableContainer td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      background-color: white; /* Ensure white background */
    }
</style>
</body>
</html>