<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History - RideShare</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="back-nav"><a href="javascript:history.back()">&leftarrow; Back</a></div>

<div class="home-container">
    <h2>Transaction History</h2>
    <p id="userNameDisplay"></p>



    <div id="historyTableContainer">
        <p>Loading transactions...</p>
    </div>
</div>

<script src="js/common.js"></script>
<script>
    const BASE_URL = "http://localhost:8080/api/auth"; // NOTE: The PaymentController uses /api/payments not /api/auth
    const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));

    // Pagination state
    let allPayments = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    document.addEventListener('DOMContentLoaded', () => {
      if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
          Swal.fire('Access Denied', 'Please log in as a Passenger.', 'warning').then(() => {
              window.location.href = 'user-login.html';
          });
          return;
      }
      document.getElementById('userNameDisplay').textContent = `Showing history for: ${LOGGED_IN_USER.name}`;
      loadTransactionHistory(LOGGED_IN_USER.id);
    });

    async function loadTransactionHistory(passengerId) {
      const container = document.getElementById('historyTableContainer');
      // CRITICAL: The endpoint is /api/payments, outside the /api/auth path defined in common.js BASE_URL
      const url = `http://localhost:8080/api/payments/passenger/${passengerId}`;

      try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch data.');

          allPayments = await response.json();
          currentPage = 1;

          if (allPayments.length === 0) {
              container.innerHTML = '<p>No transactions found.</p>';
              return;
          }

          displayTransactions();

      } catch (error) {
          Swal.fire('Error', `Failed to load history: ${error.message}`, 'error');
          container.innerHTML = '<p>Error loading transaction data.</p>';
      }
    }

    function displayTransactions() {
        const container = document.getElementById('historyTableContainer');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paymentsToDisplay = allPayments.slice(startIndex, endIndex);
        const totalPages = Math.ceil(allPayments.length / itemsPerPage);

        let tableHtml = `
            <div style="text-align: center; margin-bottom: 15px; color: #666;">
                Showing ${startIndex + 1} - ${Math.min(endIndex, allPayments.length)} of ${allPayments.length} transactions
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount (₹)</th>
                        <th>Status</th>
                        <th>Transaction ID</th>
                    </tr>
                </thead>
                <tbody>`;

        paymentsToDisplay.forEach(p => {
            tableHtml += `
                <tr>
                    <td>${new Date(p.paymentDate).toLocaleString()}</td>
                    <td>₹${p.amount.toFixed(2)}</td>
                    <td><span style="color: ${p.status === 'SUCCESS' ? 'green' : 'red'}; font-weight: bold;">${p.status}</span></td>
                    <td>${p.transactionId}</td>
                </tr>`;
        });

        tableHtml += `</tbody></table>`;

        // Add pagination controls if there are multiple pages
        if (totalPages > 1) {
            tableHtml += `
                <div class="pagination">
                    <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                    <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                    <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
                </div>
            `;
        }

        container.innerHTML = tableHtml;
    }

    function changePage(page) {
        const totalPages = Math.ceil(allPayments.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            displayTransactions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
</script>
<style>
    /* Basic table style for transaction history, borrowing from ride-results or style.css */

<!--    body {-->
<!--          /* Apply the consistent background image */-->
<!--          background: url('images/blue_abstract_bg.png') no-repeat center center fixed;-->
<!--          background-size: cover;-->
<!--          margin: 0;-->
<!--          padding: 0;-->
<!--          font-family: 'Poppins', sans-serif;-->
<!--        }-->

    #historyTableContainer table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #historyTableContainer th, #historyTableContainer td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    #historyTableContainer th {
      background-color: #4facfe;
      color: white;
    }

    /* Pagination Styles */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        padding: 15px;
    }
    .pagination button {
        background-color: #4facfe;
        color: white;
        padding: 8px 15px;
        min-width: 40px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .pagination button:hover:not(:disabled) {
        background-color: #00f2fe;
        color: #333;
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination .page-info {
        font-weight: bold;
        color: #4facfe;
    }
</style>
</body>
</html>