<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ride Search Results</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://js.stripe.com/v3/"></script>

  <style>
    /* ===== Global Page Style ===== */
<!--    body {-->
<!--      font-family: 'Poppins', Arial, sans-serif;-->
<!--      /* This ensures the blue background is visible */-->
<!--      background: url('images/blue_abstract_bg.png') no-repeat center center fixed;-->
<!--      background-size: cover;-->
<!--      margin: 0;-->
<!--      padding: 0;-->
<!--      color: #333;-->
<!--    }-->

    /* ===== Back Button ===== */
    .back-nav {
      position: absolute;
      top: 20px;
      left: 20px;
    }

    .back-nav a {
      /* Standardize back button color to primary blue */
      background-color: #4facfe;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      font-size: 15px;
      transition: background-color 0.3s ease;
    }

    .back-nav a:hover {
      background-color: #00f2fe;
      color: #333;
    }

    /* ===== Main Container (form-container) ===== */
    .form-container {
      width: 90%;
      max-width: 1000px;
      margin: 80px auto;
      border-radius: 10px;
      padding: 25px 35px;
      /* FIX 1: Make container transparent with blur */
      background-color: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* ===== Headings ===== */
    h2 {
      text-align: center;
      /* Standardize heading color */
      color: #4facfe;
      margin-bottom: 10px;
      font-size: 26px;
    }

    h3 {
      color: #333;
      margin-top: 20px; /* Corrected spacing */
      text-align: left;
    }

    /* ===== Paragraphs ===== */
    p {
      color: #555;
      text-align: center;
      margin: 5px 0;
    }

    /* ===== Table Styles ===== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 15px;
    }

    th, td {
      border: 1px solid #dee2e6;
      padding: 10px 12px;
      text-align: center;
      /* FIX 2: Make table cells semi-transparent */
      background-color: rgba(255, 255, 255, 0.5);
    }

    th {
      /* Standardize table header color */
      background-color: #4facfe;
      color: #fff;
      font-weight: normal;
    }

    tr:nth-child(even) {
      /* Light shade for alternate rows, keeping transparency */
      background-color: rgba(0, 0, 0, 0.05);
    }

    /* ===== Buttons (General Style) ===== */
    button {
      /* FIX 3: Use consistent primary blue color */
      background-color: #4facfe;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      /* FIX 3: Use consistent secondary/hover blue color */
      background-color: #00f2fe;
      color: #333; /* Darker text for light hover background */
    }

    .small-button {
      padding: 6px 10px;
      font-size: 13px;
    }

    /* ===== FIX 4: Action Column Layout (for overlapping buttons) ===== */
    #resultsContainer td:last-child {
        /* Use flexbox to organize the buttons neatly in the center */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        gap: 5px; /* Spacing between the buttons */
    }

    /* ===== New Search Button ===== */
    .form-container button {
      display: inline-block;
      margin-top: 15px;
    }

    /* ===== SweetAlert Font ===== */
    .swal2-popup {
      font-size: 15px !important;
    }

    /* ===== Pagination Styles ===== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 15px;
    }

    .pagination button {
      padding: 8px 15px;
      min-width: 40px;
      border-radius: 5px;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-info {
      font-weight: bold;
      color: #4facfe;
    }
  </style>
</head>

<body>
<div class="back-nav"><a href="javascript:history.back()">&larr; Back</a></div>

<div class="form-container">
  <h2>Ride Search Results</h2>
  <p id="searchSummary">Loading search results...</p>

  <div id="resultsContainer">
    <p>A table of results will be displayed here.</p>
  </div>

  <button onclick="window.location.href='search-ride.html'">New Search</button>
</div>

<script src="js/common.js"></script>
<script>
  // IMPORTANT: Use the Publishable Key from application.properties
  const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SPKdwQ7MCytR2QbudyenKYU4G0OviOTr5DnMKoxFMduzozaKUgjeKgDgV9tHOTDrk47UBJg1KAc7Cw44z87Yvtd00JIdFHXBN';
  const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

  const LOGGED_IN_USER = JSON.parse(localStorage.getItem("loggedInUser"));

  // Global state for Payment Element
  let elements;

  // Pagination state
  let allRides = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  document.addEventListener('DOMContentLoaded', loadSearchResults);

  // --- loadSearchResults function (Modified for Loading Spinner) ---
  async function loadSearchResults() {
      const resultsDiv = document.getElementById('resultsContainer');
      const summaryP = document.getElementById('searchSummary');
      const storedParams = sessionStorage.getItem('lastSearchParams');

      if (!storedParams) {
          summaryP.textContent = "No recent search performed.";
          resultsDiv.innerHTML = '<p>Please go back and perform a search.</p>';
          return;
      }

      const params = JSON.parse(storedParams);

      summaryP.innerHTML = `Searching for rides from <strong>${params.source}</strong> to <strong>${params.destination}</strong>.`;
      resultsDiv.innerHTML = '<p>Loading rides...</p>';

      // ðŸ”„ 1. Show loading indicator immediately (Step 1)
      Swal.fire({
          title: 'Searching...',
          text: 'Fetching available rides from server.',
          allowOutsideClick: false,
          didOpen: () => {
              Swal.showLoading();
          }
      });
      // ------------------------------------------

      // Note: The URL still includes filters which are not yet implemented in the backend logic provided.
      const url = `http://localhost:8080/api/rides/search?source=${encodeURIComponent(params.source)}&destination=${encodeURIComponent(params.destination)}&date=${encodeURIComponent(params.date)}&price=${params.price}&type=${params.vehicleType}&rating=${params.rating}`;

      try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(response.statusText || 'Failed to retrieve data.');
          // CRITICAL: response now contains the enhanced DTO data (List<RideDetailsResponse>)
          const rides = await response.json();

          let tableHtml = `
              <h3>Found ${rides.length} Ride(s)</h3>
              <table>
                  <thead><tr>
                      <th>Source</th>
                      <th>Destination</th>
                      <th>Driver/Vehicle</th> <th>Date/Time</th>
                      <th>Seats Left</th>
                      <th>Fare/Seat (â‚¹)</th>
                      <th>Action</th>
                  </tr></thead>
                  <tbody>`;

          if (rides.length === 0) {
               // colspan changed from 6 to 7
               tableHtml += '<tr><td colspan="7" style="text-align:center;">No rides match your search criteria.</td></tr>';
          } else {
              rides.forEach(ride => {
                  tableHtml += `
                      <tr>
                          <td>${ride.source}</td>
                          <td>${ride.destination}</td>
                          <td>
                            <strong>Driver:</strong> ${ride.driverName}<br>
                            <strong>Vehicle No:</strong> ${ride.vehicleNumber}
                          </td>
                          <td>${ride.dateTime.replace('T', ' ')}</td>
                          <td>${ride.availableSeats}</td>
                          <td>${ride.farePerSeat.toFixed(2)}</td>
                          <td>
                            <button class="small-button" onclick="showDriverDetails('${encodeURIComponent(JSON.stringify(ride))}')">Details</button>
</td>
                      </tr>`;
              });
          }

          tableHtml += `</tbody></table>`;
          resultsDiv.innerHTML = tableHtml;

          // ðŸ”„ 2. Close loading and show success alert
          Swal.close();
          Swal.fire('Search Complete', `Found ${rides.length} rides.`, 'success');
          // ------------------------------------------
      } catch (error) {
          // ðŸ”„ 2. Close loading and show error alert
          Swal.close();
          Swal.fire('Connection Error', `Failed to load search results: ${error.message}`, 'error');
          // ------------------------------------------
          resultsDiv.innerHTML = '<h3>Error</h3><p>Failed to connect to backend or retrieve data.</p>';
      }
  }
function displayRides() {
      const resultsDiv = document.getElementById('resultsContainer');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const ridesToDisplay = allRides.slice(startIndex, endIndex);
      const totalPages = Math.ceil(allRides.length / itemsPerPage);

      let tableHtml = `
          <h3>Found ${allRides.length} Ride(s) - Page ${currentPage} of ${totalPages}</h3>
          <table>
              <thead><tr>
                  <th>Source</th>
                  <th>Destination</th>
                  <th>Driver/Vehicle</th> <th>Date/Time</th>
                  <th>Seats Left</th>
                  <th>Fare/Seat (â‚¹)</th>
                  <th>Action</th>
              </tr></thead>
              <tbody>`;

      if (ridesToDisplay.length === 0) {
           tableHtml += '<tr><td colspan="7" style="text-align:center;">No rides match your search criteria.</td></tr>';
      } else {
          ridesToDisplay.forEach(ride => {
              tableHtml += `
                  <tr>
                      <td>${ride.source}</td>
                      <td>${ride.destination}</td>
                      <td>
                        <strong>Driver:</strong> ${ride.driverName}<br>
                        <strong>Vehicle No:</strong> ${ride.vehicleNumber}
                      </td>
                      <td>${ride.dateTime.replace('T', ' ')}</td>
                      <td>${ride.availableSeats}</td>
                      <td>${ride.farePerSeat.toFixed(2)}</td>
                      <td>
                        <button class="small-button" onclick="showDriverDetails('${encodeURIComponent(JSON.stringify(ride))}')"ï¿½>Details</button>
</td>
                  </tr>`;
          });
      }

      tableHtml += `</tbody></table>`;

      // Add pagination controls if there are multiple pages
      if (totalPages > 1) {
          tableHtml += `
              <div class="pagination">
                  <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
                  <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                  <span class="page-info">Page ${currentPage} of ${totalPages}</span>
                  <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                  <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
              </div>
          `;
      }

      resultsDiv.innerHTML = tableHtml;
  }

  function changePage(page) {
      const totalPages = Math.ceil(allRides.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
          currentPage = page;
          displayRides();
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
  }

function showDriverDetails(rideJsonString) {
      // 1. Save the full ride object JSON string to session storage
      sessionStorage.setItem('selectedRideDetails', decodeURIComponent(rideJsonString));

      // 2. Navigate to the new details page
      window.location.href = 'ride-details.html';
  }
 // --- NEW/REPLACED FUNCTION: Handles Payment Element Flow (Modified for Loading Spinners) ---
async function bookRide(rideId, seats, farePerSeat) {
    if (!LOGGED_IN_USER || LOGGED_IN_USER.roleType !== 'PASSENGER') {
        Swal.fire('Access Denied', 'Please log in as a Passenger to book seats.', 'warning');
        return;
    }

    const totalCost = (farePerSeat * seats).toFixed(2);

    // ðŸ”„ 1. Show loading indicator before fetching Payment Intent (First loading screen)
    // This addresses "iam not getting loading spinner when i click on book seat"
    Swal.fire({
        title: 'Starting Payment...',
        text: 'Securing transaction details.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    // ------------------------------------------

    // 1. CALL BACKEND to create the Payment Intent and get the Client Secret
    const intentUrl = `http://localhost:8080/api/booking/create-intent?rideId=${rideId}&seats=${seats}`;

    try {
        const intentResponse = await fetch(intentUrl, { method: 'POST' });
        if (!intentResponse.ok) {
            const errorText = await intentResponse.text();
            throw new Error(errorText || 'Failed to initialize payment.');
        }
        const { clientSecret } = await intentResponse.json();

        // ðŸ”„ 2. Close loading spinner once clientSecret is retrieved and show Payment Element modal
        Swal.close();

        // 2. Show Payment Element modal
        const { value: paymentIntentId, isConfirmed } = await Swal.fire({
            title: `Confirm Booking: â‚¹${totalCost}`,
            html: `
                <p style="text-align:center; font-size:1.0em; margin-bottom: 20px;">
                    Enter details below to confirm payment for ${seats} seat(s).
                </p>
                <div id="payment-element" style="min-height: 200px;">
                    </div>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Submit Payment',
            // CRITICAL: Initialize Payment Element when modal opens
            didOpen: () => {
                elements = stripe.elements({ clientSecret });
                const paymentElement = elements.create('payment', {
                    defaultValues: {
                        billingDetails: {
                            name: LOGGED_IN_USER.name,
                            email: LOGGED_IN_USER.email,
                        },
                    },
                });
                paymentElement.mount('#payment-element');
            },
            // CRITICAL: Handle payment confirmation when "Submit Payment" is clicked
            preConfirm: async () => {

                // ðŸ”„ 3. Show loading spinner after the user clicks "Submit Payment" (Second loading screen)
                // This addresses "when i click on submit payment"
                Swal.showLoading();
                // ------------------------------------------

                const { error, paymentIntent } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        // Return URL is mandatory for handling 3DS/redirects
                        return_url: "http://localhost:8080/ride-results.html",
                    },
                    redirect: 'if_required',
                });

                // If there is an error in confirmPayment (e.g., validation), hide spinner and show validation message
                if (error) {
                    Swal.hideLoading();
                    // Display validation/network errors back in the modal
                    Swal.showValidationMessage(`Payment failed: ${error.message}`);
                    return false;
                }

                if (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_action') {
                    // Return the Payment Intent ID to the booking function
                    return paymentIntent.id;
                } else {
                    Swal.hideLoading();
                    Swal.showValidationMessage(`Payment status: ${paymentIntent.status}`);
                    return false;
                }
            },
        });

        // 3. Final Booking Confirmation (Handles success or return from 3DS redirect)
        if (isConfirmed && paymentIntentId) {
            // ðŸ”„ 4. Show loading spinner for final backend processing (Third loading screen, if step 3 above hid it)
            // This is necessary because the preConfirm flow might close/hide the spinner before the final backend call begins.
            Swal.fire({
                title: 'Confirming Booking...',
                text: 'Processing final server steps.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            // ------------------------------------------

            // Call the final booking endpoint, using the PaymentIntent ID
            const bookingUrl = `http://localhost:8080/api/booking/book?paymentMethodId=${encodeURIComponent(paymentIntentId)}`;

            const finalBookingResponse = await fetch(bookingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rideId: rideId,
                    passengerId: LOGGED_IN_USER.id,
                    seatsBooked: seats,
                })
            });

            // ðŸ”„ 5. Close loading spinner
            Swal.close();
            // ------------------------------------------

            const resultText = await finalBookingResponse.text();

            // IMPORTANT: The server may return STRIPE_3DS_REQUIRED: redirectUrl
            if (resultText && resultText.startsWith('STRIPE_3DS_REQUIRED:')) {
                const redirectUrl = resultText.substring('STRIPE_3DS_REQUIRED:'.length);
                Swal.fire({
                    icon: 'info',
                    title: 'Payment Redirection Required',
                    text: 'You will be redirected to your bank to complete 3D Secure authentication.',
                    confirmButtonText: 'Continue to Bank'
                }).then(() => {
                    window.location.href = redirectUrl; // Redirect the user!
                });
            } else if (finalBookingResponse.ok) {
                Swal.fire('Booking Success!', resultText, 'success').then(() => {
                    loadSearchResults();
                });
            } else {
                Swal.fire('Booking Failed', resultText || 'Server error during booking.', 'error');
            }
        }
    } catch (error) {
        console.error("Payment flow error:", error);
        // Catch errors from the initial create-intent call
        Swal.close(); // Ensure loading spinner is closed
        Swal.fire('Error', `Failed to start payment flow: ${error.message}`, 'error');
    }
}
</script>
</body>
</html>